#!/bin/bash
#addmedia
[ -d $HOME/.tempdata ] || mkdir $HOME/.tempdata
source /opt/karoshi/serversetup/variables/language
source /opt/karoshi/serversetup/language/$LANGCHOICE/addmedia
source /opt/karoshi/serversetup/variables/xdialog
source /opt/karoshi/serversetup/variables/distro

########################
#Display cancelled box when called
########################

function CANCELLEDBOX {
Xdialog --title "$TITLE" \
--icon $ICON --rc-file $RCFILE --msgbox "$TITLE \n\n$CANCELLEDMSG" 16 50
case $ in
0)
	exit;;
255)
	exit;;
esac
}


###########################
#Display opening message
###########################
DIALOG=${DIALOG=Xdialog}

$DIALOG --title "$TITLE" --clear \
        --wrap --icon $ICON --rc-file $RCFILE --ok-label $CONTINUEMSG --cancel-label $EXITMSG --yesno "$OPENINGMSG1" 16 50

case $? in
  0)
   CHOICE=go;;
  1)
    CHOICE=x;;
  255)
    CHOICE=x;;
esac

if [ $CHOICE = x ]
then
CANCELLEDBOX
exit
fi


########################
#Get official source list
########################

###########################
#Ask to get new download list from the mandriva website
###########################
DIALOG=${DIALOG=Xdialog}

$DIALOG --title "$TITLE" --clear \
        --wrap --icon $ICON --rc-file $RCFILE --ok-label $YESMSG --cancel-label $NOMSG --yesno "$GETNEWMEDIAMESG" 16 50

case $? in
  0)
   CHOICE=go;;
  1)
    CHOICE=x;;
  255)
    CHOICE=x;;
esac


if [ $CHOICE = go ]
then
cd $HOME/.tempdata
xterm -geometry 100x20 -bg white -fg black -e wget http://www.mandrivalinux.com/mirrorsfull.list
if [ -e $HOME/.tempdata/mirrorsfull.list ]
then
grep officiali586 $HOME/.tempdata/mirrorsfull.list | cut -d: -f2,3 > $HOME/.tempdata/mandrivai5861.list
cut -d/ -f1,2,3 $HOME/.tempdata/mandrivai5861.list > $HOME/.tempdata/mandrivai5862.list 

NUMBEROFLINES=`cat $HOME/.tempdata/mandrivai5861.list | wc -l`
rm -f /opt/karoshi/serversetup/distro/$DISTROCHOICE/mirrorsources/Mandriva_Official_i586
COUNTER=1
         while [  $COUNTER -le $NUMBEROFLINES ]; do
         
SOURCEPATH=`sed -n $COUNTER,$COUNTER'p' $HOME/.tempdata/mandrivai5861.list`
SOURCENAME=`sed -n $COUNTER,$COUNTER'p' $HOME/.tempdata/mandrivai5862.list`
echo $SOURCENAME'	'$SOURCEPATH'	'media_info/hdlist.cz >> /opt/karoshi/serversetup/distro/$DISTROCHOICE/mirrorsources/Mandriva_Official_i586
let COUNTER=COUNTER+1
done



grep officialx86_64 $HOME/.tempdata/mirrorsfull.list | cut -d: -f2,3 > $HOME/.tempdata/mandrivax86_641.list
cut -d/ -f1,2,3 $HOME/.tempdata/mandrivax86_641.list > $HOME/.tempdata/mandrivax86_642.list

NUMBEROFLINES=`cat $HOME/.tempdata/mandrivax86_641.list | wc -l`
rm -f /opt/karoshi/serversetup/distro/$DISTROCHOICE/mirrorsources/Mandriva_Official_x86_64
COUNTER=1
         while [  $COUNTER -le $NUMBEROFLINES ]; do
         
SOURCEPATH=`sed -n $COUNTER,$COUNTER'p' $HOME/.tempdata/mandrivax86_641.list`
SOURCENAME=`sed -n $COUNTER,$COUNTER'p' $HOME/.tempdata/mandrivax86_642.list`
echo $SOURCENAME'	'$SOURCEPATH'	'media_info/hdlist.cz >> /opt/karoshi/serversetup/distro/$DISTROCHOICE/mirrorsources/Mandriva_Official_x86_64
let COUNTER=COUNTER+1
done
rm -f $HOME/.tempdata/mandrivai5861.list
rm -f $HOME/.tempdata/mandrivai5862.list
rm -f $HOME/.tempdata/mandrivax86_641.list
rm -f $HOME/.tempdata/mandrivax86_642.list
rm -f $HOME/.tempdata/mirrorsfull.list
fi
fi
#####################
#Choose which source list to use
#####################
########################
#Generate list of source files
########################
dir --format=single-column /opt/karoshi/serversetup/distro/$DISTROCHOICE/mirrorsources > $HOME/.tempdata/profilestemp
sed 's/ //g' $HOME/.tempdata/profilestemp | sed 's/[\]//g' > $HOME/.tempdata/profilestempnospaces
wc -l $HOME/.tempdata/profilestemp > $HOME/.tempdata/numberofprofiles
NUMBEROFPROFILES=`cut $HOME/.tempdata/numberofprofiles -d' ' -f1`
rm -f $HOME/.tempdata/profiles
COUNTER=1
         while [  $COUNTER -le $NUMBEROFPROFILES ]; do
	 
	 PROFILE=`sed -n $COUNTER,$COUNTER'p' $HOME/.tempdata/profilestempnospaces`
             echo $PROFILE . off >> $HOME/.tempdata/profiles
             let COUNTER=COUNTER+1
         done
PROFILES=`cat $HOME/.tempdata/profiles`
rm -f $HOME/.tempdata/numberofprofiles
rm -f $HOME/.tempdata/profiles
rm -f $HOME/.tempdata/profilestemp
rm -f $HOME/.tempdata/profilestempnospaces

###########################
#Create checklist box for selection
###########################
DIALOG=${DIALOG=Xdialog}
tempfile=`tempfile 2>/dev/null` || tempfile=$HOME/.tempdata/sourcename
trap "rm -f $tempfile" 0 1 2 5 15

$DIALOG --wrap --icon $ICON --rc-file $RCFILE --backtitle "$TITLE" \
        --title "$TITLE" --clear \
        --radiolist "$CHECKLISTMSG" 40 61 5 \
        $PROFILES 2> $HOME/.tempdata/sourcename

retval=$?

choice=`cat $tempfile`
case $retval in
  0)
    CHOICE=go;;
  1)
    CHOICE=stop;;
  255)
    CHOICE=stop;;
esac
rm -f $HOME/.tempdata/sourcename
#####################
#Show cancelled msg if chosen
#####################
if [ $CHOICE = stop ]
then
CANCELLEDBOX
exit
fi

#####################
#Get list of sources from config file
#####################
DIALOG=${DIALOG=Xdialog}
tempfile=`tempfile 2>/dev/null` || tempfile=$HOME/.tempdata/setupchoice
trap "rm -f $tempfile" 0 1 2 5 15
cut -f 1 /opt/karoshi/serversetup/distro/$DISTROCHOICE/mirrorsources/$choice > $HOME/.tempdata/menulist
cut -f 2 /opt/karoshi/serversetup/distro/$DISTROCHOICE/mirrorsources/$choice > $HOME/.tempdata/sourcelist1
cut -f 3 /opt/karoshi/serversetup/distro/$DISTROCHOICE/mirrorsources/$choice > $HOME/.tempdata/sourcelist2
NUMBEROFLINES=`cat $HOME/.tempdata/menulist | wc -l`

COUNTER=1
         while [  $COUNTER -le $NUMBEROFLINES ]; do
	 
	 LINE=`sed -n $COUNTER,$COUNTER'p' $HOME/.tempdata/menulist`
             echo $LINE . main >> $HOME/.tempdata/menulist2
             let COUNTER=COUNTER+1
         done

menulist=`cat $HOME/.tempdata/menulist2`
######################
#Show list of sources
######################
$DIALOG --icon $ICON --rc-file $RCFILE --backtitle "$TITLE" \
        --title "$TITLE" --clear \
        --cancel-label Quit --radiolist "$CHOOSEMEDIAMSG" 50 85 5 \
	$menulist 2> $HOME/.tempdata/setupchoice
	 
retval=$?

choice=`cat $tempfile`
case $retval in
  0)
    CHOICE=go;;
  1)
    CHOICE=stop;;
  255)
    CHOICE=stop;;
esac

rm -f $HOME/.tempdata/menulist
rm -f $HOME/.tempdata/menulist2

if [ $CHOICE = stop ]
then
CANCELLEDBOX
rm -f $HOME/.tempdata/sourcelist1
rm -f $HOME/.tempdata/sourcelist2
exit
fi

SOURCECHOICE=`cat $HOME/.tempdata/setupchoice`
rm -f $HOME/.tempdata/setupchoice 2>/dev/null
#########################
#get variables for chosen media
#########################
grep -n -o $SOURCECHOICE $HOME/.tempdata/sourcelist1 > $HOME/.tempdata/chosenmedia
LINENUMBER=`cut -d: -f1 $HOME/.tempdata/chosenmedia`
echo $LINENUMBER
rm -f $HOME/.tempdata/chosenmedia

SOURCEADDRESS=`sed -n $LINENUMBER,$LINENUMBER'p' $HOME/.tempdata/sourcelist1`
RELATIVEPATH=`sed -n $LINENUMBER,$LINENUMBER'p' $HOME/.tempdata/sourcelist2`
rm -f $HOME/.tempdata/sourcelist1
rm -f $HOME/.tempdata/sourcelist2

#######################
#Confirm addmedia
#######################
DIALOG=${DIALOG=Xdialog}

$DIALOG --title "$TITLE" --clear \
        --wrap --icon $ICON --rc-file $RCFILE --yesno "$SOURCECHOICE \n\n $CONFIRMMESG" 16 50

case $? in
  0)
   CHOICE=go;;
  1)
    CHOICE=x;;
  255)
    CHOICE=x;;
esac

if [ $CHOICE = x ]
then
CANCELLEDBOX
exit
fi
##########################
#Remove current media main
##########################
urpmi.removemedia main

##########################
#Add media
##########################

xterm -geometry 100x20 -bg white -fg black -e urpmi.addmedia main $SOURCEADDRESS with $RELATIVEPATH

#######################
#Show completed messsage
#######################
MEDIALIST=`urpmq --list-url`
Xdialog --title "$TITLE" \
--wrap --icon $ICON --rc-file $RCFILE --infobox "$COMPLETEDMSG1 \n\n $MEDIAURLMSG1: \n $MEDIALIST" 30 100 3000
case $ in
0)
	exit;;
255)
	exit;;
esac
exit
  
