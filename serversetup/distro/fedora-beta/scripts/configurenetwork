#!/bin/bash
#configurenetwork
source /opt/karoshi/serversetup/variables/tcpip
source /opt/karoshi/serversetup/variables/ltsp_tcpip
####################
#Set Computer name and gateway
####################
function setnetwork {
echo HOSTNAME=$KAROSHISERVER > /etc/sysconfig/network
echo NETWORKING=yes >> /etc/sysconfig/network
echo GATEWAY=${!GATEWAY} >> /etc/sysconfig/network
echo GATEWAYDEV=eth0 >> /etc/sysconfig/network
echo NISDOMAIN=linuxgridnis >> /etc/sysconfig/network
####################
#Set Nameserver
####################
echo nameserver ${!NAMESERVER} > /etc/resolv.conf
####################
#Set TCP/IP
####################
echo DEVICE=eth0 > /etc/sysconfig/network-scripts/ifcfg-eth0
echo BOOTPROTO=static >> /etc/sysconfig/network-scripts/ifcfg-eth0
echo IPADDR=${!KAROSHISERVERCAPS} >> /etc/sysconfig/network-scripts/ifcfg-eth0
echo NETMASK=${!NETMASK} >> /etc/sysconfig/network-scripts/ifcfg-eth0
echo BROADCAST=${!BROADCAST} >> /etc/sysconfig/network-scripts/ifcfg-eth0
echo ONBOOT=yes >> /etc/sysconfig/network-scripts/ifcfg-eth0
echo METRIC=10 >> /etc/sysconfig/network-scripts/ifcfg-eth0
echo MII_NOT_SUPPORTED=no >> /etc/sysconfig/network-scripts/ifcfg-eth0
echo USERCTL=no >> /etc/sysconfig/network-scripts/ifcfg-eth0
###################
#Change TCP/IP
###################
ifdown eth0
ifup eth0
}
setnetwork
###################
#Check DNS
###################
if [ $KAROSHISERVER != colossus ] && [ $KAROSHISERVER != cassandra ]
then 
ping -c 1 ${!NAMESERVER}
if [ `echo $?` = 1 ]
then
#Show warning message
/opt/karoshi/serversetup/scripts/dnswarning
#Change DNS if default is not available
ping -c 1 $XEN
if [ `echo $?` = 0 ]
then
NAMESERVER=XEN
else
NAMESERVER=$KAROSHISERVERCAPS
fi
setnetwork
fi
fi
###################
#Change hostname
###################
hostname $KAROSHISERVER
killall dhclient
killall startkde
